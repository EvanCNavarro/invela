> rest-express@1.0.0 dev
Database migrations disabled - schema already applied
[EmailService] Initializing email service
[EmailService] Email service initialized successfully
[Auth] Setting up authentication...
[Auth] Authentication setup completed
[2025-04-21T13:08:38.134Z] [INFO] [OpenBankingRoutes] [OpenBankingRoutes] Setting up routes...
[Routes] Routes setup completed
[WebSocket] Server initialized on path: /ws
1:08:38 PM [info] Setting up Vite development server
1:08:38 PM [express] Server running on port 5000
New WebSocket client connected
New WebSocket client connected
[2025-04-21T13:08:45.375Z] New client connected to the pool (1/3)
[Auth] Deserializing user: 273
[Current Company] Fetching company for user: { userId: 273, companyId: 232 }
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
[Current Company] Found company: {
  id: 232,
  name: 'DevTest26',
  onboardingCompleted: false,
  riskScore: null,
  isDemo: true
}
[Auth] Using cached user data: 273
[2025-04-21T13:08:50.131Z] New client connected to the pool (2/3)
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[2025-04-21T13:08:50.485Z] New client connected to the pool (3/3)
[Auth] Unauthenticated user session
New WebSocket client connected
[Auth] Using cached user data: 273
WebSocket client disconnected with code 1001 and reason: 
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Returning user session data
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 273, company_id: 232, email: '26@e.com' }
[2025-04-21T13:08:57.894Z] [INFO] [KYBRoutes] Performing dynamic task unlocking check for company {"companyId":232,"userId":273}
[Tasks Routes] Fetching task by ID (special .json endpoint): {
  taskId: 601,
  userCompanyId: 232,
  timestamp: '2025-04-21T13:08:57.900Z'
}
[2025-04-21T13:08:57.931Z] [INFO] [KYBRoutes] Found completed KYB tasks, checking security tasks to unlock {"companyId":232,"kybTaskCount":1}
[Tasks Routes] Task found by ID (special .json endpoint): {
  taskId: 601,
  title: '2. S&P KY3P Security Assessment: DevTest26',
  type: 'sp_ky3p_assessment',
  formDataFields: 0,
  timestamp: '2025-04-21T13:08:57.933Z'
}
1:08:57 PM [info] GET /api/companies/current 200 in 54ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
[2025-04-21T13:08:57.963Z] [INFO] [KYBRoutes] All security tasks are already unlocked {"companyId":232}
1:08:57 PM [info] GET /api/tasks.json/601 304 in 86ms :: {"id":601,"title":"2. S&P KY3P Security Assessment: DevTest26","description":...
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 273',
    condition2: 'tasks.created_by = 273',
    condition3: "tasks.company_id = 232 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('26@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
New WebSocket client connected
1:08:58 PM [info] GET /api/tasks 304 in 164ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:08:58.166Z' }
[Task Templates API] Fetching template for task type: sp_ky3p_assessment, user: 273
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
1:08:58 PM [warn] GET /api/companies/is-demo 400 in 35ms :: {"message":"Invalid company ID","code":"INVALID_ID"}
[Task Templates API] Found template: 48 (S&P KY3P Security Assessment) for task type: sp_ky3p_assessment
[Task Templates API] Retrieved 10 configuration items for template ID: 48
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:08:58.237Z'
}
1:08:58 PM [info] GET /api/tasks 304 in 34ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
1:08:58 PM [info] GET /api/task-templates/by-type/sp_ky3p_assessment 304 in 100ms :: {"id":48,"name":"S&P KY3P Security Assessment","description":"S&P KY3P Securi...
1:08:58 PM [info] POST /api/tasks/601/update-progress 200 in 107ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:08:58.438Z' }
[2025-04-21T13:08:58.440Z] [INFO] [KY3PRoutes] [KY3P API] Fetching KY3P fields. User authenticated: true
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
1:08:58 PM [info] GET /api/tasks 304 in 32ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:08:58.499Z'
}
[2025-04-21T13:08:58.527Z] [INFO] [KY3PRoutes] [KY3P API] Successfully retrieved 120 KY3P fields
[2025-04-21T13:08:58.527Z] [INFO] [KY3PRoutes] [KY3P API] Fields grouped by step: ["Step 0: 120 fields"]
New WebSocket client connected
1:08:58 PM [info] POST /api/tasks/601/update-progress 200 in 96ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
1:08:58 PM [info] GET /api/ky3p-fields 304 in 119ms :: [{"id":1,"order":1,"field_key":"externalSystems","display_name":"External Sys...
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:08:58.727Z' }
1:08:58 PM [info] GET /api/tasks 304 in 45ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:08:58.787Z'
}
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:08:58.802Z' }
1:08:58 PM [info] POST /api/tasks/601/update-progress 200 in 91ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:08:58.874Z'
}
1:08:58 PM [info] POST /api/tasks/601/update-progress 200 in 108ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
1:08:59 PM [info] GET /api/tasks 304 in 33ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
1:08:59 PM [info] GET /api/tasks 304 in 30ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[WebSocket] Received ping
[WebSocket] Received ping
Suppressing further connection logs. Pool size: 3
[Current Company] Fetching company for user: { userId: 273, companyId: 232 }
[Current Company] Found company: {
  id: 232,
  name: 'DevTest26',
  onboardingCompleted: false,
  riskScore: null,
  isDemo: true
}
1:10:08 PM [info] GET /api/companies/current 304 in 61ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
[WebSocket] Received ping
[WebSocket] Received ping
[WebSocket] Received ping
[Current Company] Fetching company for user: { userId: 273, companyId: 232 }
[Current Company] Found company: {
  id: 232,
  name: 'DevTest26',
  onboardingCompleted: false,
  riskScore: null,
  isDemo: true
}
1:11:16 PM [info] GET /api/companies/current 304 in 61ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 273, company_id: 232, email: '26@e.com' }
[2025-04-21T13:11:20.104Z] [INFO] [KYBRoutes] Performing dynamic task unlocking check for company {"companyId":232,"userId":273}
[2025-04-21T13:11:20.136Z] [INFO] [KYBRoutes] Found completed KYB tasks, checking security tasks to unlock {"companyId":232,"kybTaskCount":1}
[2025-04-21T13:11:20.165Z] [INFO] [KYBRoutes] All security tasks are already unlocked {"companyId":232}
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 273',
    condition2: 'tasks.created_by = 273',
    condition3: "tasks.company_id = 232 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('26@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
1:11:20 PM [info] GET /api/companies/current 304 in 31ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
1:11:20 PM [info] GET /api/tasks 304 in 156ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
1:11:20 PM [info] GET /api/tasks 304 in 35ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Using cached user data: 273
[Auth] Returning user session data
1:11:31 PM [info] GET /api/companies/current 304 in 30ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
1:11:31 PM [info] GET /api/tasks 304 in 32ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
New WebSocket client connected
1:11:31 PM [info] GET /api/tasks 304 in 31ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
New WebSocket client connected
[Auth] Using cached user data: 273
[Tasks Routes] Fetching task by ID (special .json endpoint): {
  taskId: 601,
  userCompanyId: 232,
  timestamp: '2025-04-21T13:11:34.028Z'
}
[Tasks Routes] Task found by ID (special .json endpoint): {
  taskId: 601,
  title: '2. S&P KY3P Security Assessment: DevTest26',
  type: 'sp_ky3p_assessment',
  formDataFields: 0,
  timestamp: '2025-04-21T13:11:34.058Z'
}
1:11:34 PM [info] GET /api/companies/current 304 in 30ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
1:11:34 PM [info] GET /api/tasks.json/601 304 in 60ms :: {"id":601,"title":"2. S&P KY3P Security Assessment: DevTest26","description":...
[Task Templates API] Fetching template for task type: sp_ky3p_assessment, user: 273
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:11:34.247Z' }
[Task Templates API] Found template: 48 (S&P KY3P Security Assessment) for task type: sp_ky3p_assessment
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
1:11:34 PM [warn] GET /api/companies/is-demo 400 in 29ms :: {"message":"Invalid company ID","code":"INVALID_ID"}
[Task Templates API] Retrieved 10 configuration items for template ID: 48
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:11:34.306Z'
}
1:11:34 PM [info] GET /api/task-templates/by-type/sp_ky3p_assessment 304 in 90ms :: {"id":48,"name":"S&P KY3P Security Assessment","description":"S&P KY3P Securi...
1:11:34 PM [info] POST /api/tasks/601/update-progress 200 in 90ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:11:34.490Z' }
[2025-04-21T13:11:34.491Z] [INFO] [KY3PRoutes] [KY3P API] Fetching KY3P fields. User authenticated: true
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
1:11:34 PM [info] GET /api/tasks 304 in 36ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:11:34.552Z'
}
1:11:34 PM [info] POST /api/tasks/601/update-progress 200 in 94ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
[2025-04-21T13:11:34.605Z] [INFO] [KY3PRoutes] [KY3P API] Successfully retrieved 120 KY3P fields
[2025-04-21T13:11:34.605Z] [INFO] [KY3PRoutes] [KY3P API] Fields grouped by step: ["Step 0: 120 fields"]
1:11:34 PM [info] GET /api/ky3p-fields 304 in 144ms :: [{"id":1,"order":1,"field_key":"externalSystems","display_name":"External Sys...
1:11:34 PM [info] GET /api/tasks 304 in 29ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:11:34.807Z' }
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
[Tasks Routes] Updating task progress: { taskId: 601, timestamp: '2025-04-21T13:11:34.841Z' }
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:11:34.863Z'
}
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 601,
  status: 'submitted',
  hasSubmissionDate: true,
  submissionDate: '2025-04-21T11:12:06.132Z',
  terminalState: true
}
1:11:34 PM [info] POST /api/tasks/601/update-progress 200 in 86ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
[Tasks Routes] Task progress reconciled: {
  taskId: 601,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-21T13:11:34.900Z'
}
1:11:34 PM [info] POST /api/tasks/601/update-progress 200 in 90ms :: {"success":true,"progress":100,"status":"submitted","taskId":601}
1:11:35 PM [info] GET /api/tasks 304 in 31ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
1:11:35 PM [info] GET /api/tasks 304 in 30ms :: [{"id":599,"title":"New User Invitation: 26@e.com","description":"Complete us...
1:11:44 PM [info] GET /api/companies/current 304 in 30ms :: {"id":232,"name":"DevTest26","description":"FinTech partner company DevTest26...
1:11:54 PM [info] GET /api/companies/current 304 in 31ms :: {"id":232,"name":"DevTest26","description":"FinTech partner c