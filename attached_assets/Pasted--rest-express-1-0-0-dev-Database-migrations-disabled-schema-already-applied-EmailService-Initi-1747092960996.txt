
> rest-express@1.0.0 dev
Database migrations disabled - schema already applied
[EmailService] Initializing email service
[EmailService] Email service initialized successfully
[OpenAI] Service initialized with API key: API key is set
[WebSocketService] Initialized in fallback mode (WebSocket server not available)
[Auth] Setting up authentication...
[Auth] Setting up PostgreSQL session store
[Auth] PostgreSQL session store initialized successfully
[Auth] Authentication setup completed
[Routes] Registered KY3P form submission fix routes
[2025-05-12T23:33:08.737Z] [INFO] [App] [KY3P-BATCH-UPDATE] Registering KY3P batch update routes 
[2025-05-12T23:33:08.737Z] [INFO] [App] Registering KY3P batch update routes 
[2025-05-12T23:33:08.737Z] [INFO] [App] [UnifiedKY3P] Registering unified KY3P update routes 
[Routes] Registered KY3P field key router
[Routes] Registered KY3P field key router
[2025-05-12T23:33:08.738Z] [INFO] [App] Registering KY3P field update routes 
[Routes] Setting up unified clear fields router
[Routes] Successfully registered unified clear fields router
[Routes] Setting up task broadcast router
[Routes] Successfully registered task broadcast router
[2025-05-12T23:33:08.739Z] [INFO] [App] [OpenBankingRoutes] Setting up routes... 
[Routes] Setting up transaction-based unified form submission router
[Routes] Successfully registered transaction-based unified form submission router
[Routes] Setting up unified form submission router
[Routes] Successfully registered unified form submission router
[Routes] Setting up transactional form submission router
[Routes] Successfully registered transactional form submission router
[Routes] Routes setup completed
[2025-05-12T23:33:08.741Z] [INFO] [App] [WebSocket] Setting up unified WebSocket server on path /ws 
[2025-05-12T23:33:08.742Z] [INFO] [WebSocket] Unified WebSocket server initialized successfully {"module":"WebSocket","clients":0,"path":"/ws","id":"j35xxg","timestamp":"2025-05-12T23:33:08.742Z"}
[2025-05-12T23:33:08.742Z] [INFO] [App] [WebSocket] Unified WebSocket server initialized successfully 
[2025-05-12T23:33:08.742Z] [WARN] [App] [WebSocket] Form submission WebSocket initialization function not found 
[2025-05-12T23:33:08.742Z] [INFO] [App] [ServerStartup] WebSocket server initialized with unified implementation 
[2025-05-12T23:33:08.742Z] [INFO] [App] [TaskWebSocket] WebSocket server registered with unified implementation 
[2025-05-12T23:33:08.742Z] [INFO] [App] [ServerStartup] WebSocket server registered with task-update utility 
[TaskBroadcast] WebSocket server reference set up
[TaskBroadcast] WebSocket server active with 0 connected clients
[2025-05-12T23:33:08.743Z] [INFO] [App] [ServerStartup] WebSocket server registered with task-broadcast utility 
[2025-05-12T23:33:08.743Z] [INFO] [App] Setting up Vite development server 
[2025-05-12T23:33:08.745Z] [INFO] [App] [ENV] Server will listen on PORT=5000 (deployment mode: no) 
[2025-05-12T23:33:08.745Z] [INFO] [App] [ENV] Environment=development (NODE_ENV explicitly set) 
[2025-05-12T23:33:08.761Z] [INFO] [App] Server running on 0.0.0.0:5000 
[2025-05-12T23:33:08.761Z] [INFO] [App] Environment: development 
[Deployment] Server running on 0.0.0.0:5000
[Deployment] Environment: development
[Deployment] Port forwarding: Custom port: 5000
[Deployment] Development mode: Hot reloading enabled
[2025-05-12T23:33:08.761Z] [INFO] [App] Starting periodic task reconciliation system... 
[PeriodicTaskReconciliation] Stopped periodic reconciliation system
[PeriodicTaskReconciliation] Starting periodic reconciliation system (interval: 300000ms)
[2025-05-12T23:33:08.761Z] [INFO] [App] Task reconciliation system initialized successfully 
[2025-05-12T23:33:08.781Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092788781-tyiuuma","clients":1}
[2025-05-12T23:33:09.256Z] New client connected to the pool (1/3)
[2025-05-12T23:33:09.518Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092789518-3io4omo","clients":2}
[Auth] Returning user session data
[2025-05-12T23:33:09.697Z] [INFO] [WebSocket] Received message from client client-1747092789518-3io4omo {"module":"WebSocket","type":"authenticate","data":{"timestamp":"2025-05-12T23:33:09.466Z"}}
[2025-05-12T23:33:09.697Z] [INFO] [WebSocket] Authentication from client client-1747092789518-3io4omo {"module":"WebSocket","hasToken":true}
[2025-05-12T23:33:09.785Z] [INFO] [App] [ServerStartup] WebSocket server active with 2 connected clients 
[2025-05-12T23:33:11.106Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092791106-vmeb0wq","clients":3}
[Current Company] Fetching company for user: { userId: 328, companyId: 285 }
[Current Company] Found company: {
  id: 285,
  name: 'DevTest30',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[2025-05-12T23:33:13.461Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092793461-xq2unrg","clients":4}
[2025-05-12T23:33:13.909Z] [INFO] [App] GET /api/companies/current 304 in 913ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:33:13.909Z] [INFO] [WebSocket] Received message from client client-1747092793461-xq2unrg {"module":"WebSocket","type":"authenticate","userId":null,"companyId":null,"clientId":"ws_1747092419126_lx3g1kl8r","timestamp":"2025-05-12T23:33:13.410Z"}
[2025-05-12T23:33:13.910Z] [INFO] [WebSocket] Authentication from client client-1747092793461-xq2unrg {"module":"WebSocket","userId":null,"companyId":null,"hasToken":true}
[2025-05-12T23:33:14.239Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"authenticate","userId":328,"companyId":285,"clientId":"ws_1747092788213_kd6oz8e6j","timestamp":"2025-05-12T23:33:13.858Z"}
[2025-05-12T23:33:14.240Z] [INFO] [WebSocket] Authentication from client client-1747092788781-tyiuuma {"module":"WebSocket","userId":328,"companyId":285,"hasToken":true}
[2025-05-12T23:33:14.499Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092794499-fcaj0ex","clients":5}
[2025-05-12T23:33:16.221Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092796221-f5t306g","clients":6}
[2025-05-12T23:33:16.244Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092796244-flf4q44","clients":7}
[Auth] Unauthenticated user session
[2025-05-12T23:33:16.467Z] [INFO] [WebSocket] Received message from client client-1747092796221-f5t306g {"module":"WebSocket","type":"authenticate","data":{"timestamp":"2025-05-12T23:33:16.465Z"}}
[2025-05-12T23:33:16.467Z] [INFO] [WebSocket] Authentication from client client-1747092796221-f5t306g {"module":"WebSocket","hasToken":true}
[2025-05-12T23:33:16.498Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092796498-9nq2q9s","clients":8}
[2025-05-12T23:33:16.734Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092796244-flf4q44","code":1001,"reason":"","remainingClients":7}
[2025-05-12T23:33:16.735Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092796498-9nq2q9s","code":1001,"reason":"","remainingClients":6}
[2025-05-12T23:33:16.735Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092796221-f5t306g","code":1001,"reason":"","remainingClients":5}
[2025-05-12T23:33:29.387Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:33:29.211Z","connectionId":"ws_1747092788213_kd6oz8e6j"}
[PeriodicTaskReconciliation] Reconciling batch of 10 tasks: [
  790, 723, 719, 792,
  724, 739, 735, 767,
  746, 683
]
[Task Progress] Calculated progress for task 790 (company_kyb): 30/30 = 100%
[Task Progress] Calculated progress for task 723 (ky3p): 0/120 = 0%
[Task Progress] Calculated progress for task 719 (open_banking): 0/44 = 0%
[Task Progress] Calculated progress for task 792 (open_banking): 44/44 = 100%
[Task Progress] Calculated progress for task 724 (open_banking): 44/44 = 100%
[Task Progress] Calculated progress for task 739 (ky3p): 120/120 = 100%
[Task Progress] Calculated progress for task 735 (ky3p): 0/0 = 0%
[Task Progress] Calculated progress for task 767 (ky3p): 0/0 = 0%
[Task Progress] Calculated progress for task 746 (company_kyb): 0/30 = 0%
[Task Progress] Calculated progress for task 683 (open_banking): 0/44 = 0%
[2025-05-12T23:33:40.391Z] [INFO] [WebSocket] Received message from client client-1747092789518-3io4omo {"module":"WebSocket","type":"ping"}
[2025-05-12T23:33:41.387Z] [INFO] [WebSocket] Received message from client client-1747092791106-vmeb0wq {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:33:41.213Z","connectionId":"ws_1747092421517_xxzo2ivgw"}
[2025-05-12T23:33:45.385Z] [INFO] [WebSocket] Received message from client client-1747092794499-fcaj0ex {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:33:45.213Z","connectionId":"ws_1747092420485_xhiofdxx2"}
[2025-05-12T23:33:49.386Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:33:49.212Z","connectionId":"ws_1747092788213_kd6oz8e6j"}
[2025-05-12T23:33:57.468Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:34:09.386Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:09.213Z","connectionId":"ws_1747092788213_kd6oz8e6j"}
[2025-05-12T23:34:10.387Z] [INFO] [WebSocket] Received message from client client-1747092789518-3io4omo {"module":"WebSocket","type":"ping"}
[2025-05-12T23:34:11.388Z] [INFO] [WebSocket] Received message from client client-1747092791106-vmeb0wq {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:11.214Z","connectionId":"ws_1747092421517_xxzo2ivgw"}
[2025-05-12T23:34:15.388Z] [INFO] [WebSocket] Received message from client client-1747092794499-fcaj0ex {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:15.211Z","connectionId":"ws_1747092420485_xhiofdxx2"}
[2025-05-12T23:34:29.384Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:29.211Z","connectionId":"ws_1747092788213_kd6oz8e6j"}
[2025-05-12T23:34:40.385Z] [INFO] [WebSocket] Received message from client client-1747092789518-3io4omo {"module":"WebSocket","type":"ping"}
[2025-05-12T23:34:41.469Z] [INFO] [WebSocket] Received message from client client-1747092791106-vmeb0wq {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:41.213Z","connectionId":"ws_1747092421517_xxzo2ivgw"}
[2025-05-12T23:34:45.386Z] [INFO] [WebSocket] Received message from client client-1747092794499-fcaj0ex {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:45.212Z","connectionId":"ws_1747092420485_xhiofdxx2"}
[2025-05-12T23:34:49.386Z] [INFO] [WebSocket] Received message from client client-1747092788781-tyiuuma {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:34:49.212Z","connectionId":"ws_1747092788213_kd6oz8e6j"}
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 328, company_id: 285, email: '30@e.com' }
[2025-05-12T23:34:55.696Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":285,"userId":328}
[2025-05-12T23:34:55.726Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":285}
[Tasks] Automatically unlocking all tasks for company { userId: 328, companyId: 285, requestedBy: 'automatic_task_unlock' }
[2025-05-12T23:34:55.727Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":285}
[2025-05-12T23:34:55.750Z] New client connected to the pool (2/3)
[2025-05-12T23:34:55.757Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":809,"userEmail":"30@e.com","currentStatus":"completed","currentProgress":100}
[2025-05-12T23:34:55.757Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":285,"count":4,"taskIds":[810,811,812,809],"taskTypes":["company_kyb","ky3p","open_banking","user_onboarding"],"ky3pTaskCount":1,"ky3pTaskIds":[811]}
[UnifiedProgress] Starting progress update for task 810 (company_kyb) {
  taskId: 810,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1747092895758-567',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[Current Company] Fetching company for user: { userId: 328, companyId: 285 }
[UnifiedProgressCalc] Calculating progress for task 810 (company_kyb)
[Current Company] Found company: {
  id: 285,
  name: 'DevTest30',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[2025-05-12T23:34:55.855Z] [INFO] [App] GET /api/companies/current 304 in 60ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:34:55.906Z] New client connected to the pool (3/3)
[UnifiedProgressCalc] Task 810 (company_kyb) progress: 0/30 = 0%
[2025-05-12T23:34:56.010Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 5 clients {"module":"WebSocket","messageType":"task_updated","recipients":5,"totalClients":5,"filtered":false}
[2025-05-12T23:34:56.010Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":810,"messageId":"msg_1747092896010_872howbm"}
[2025-05-12T23:34:56.010Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 810 {"progress":0,"status":"not_started","messageId":"msg_1747092896010_872howbm"}
[2025-05-12T23:34:56.010Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":810,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-12T23:34:56.011Z] [INFO] [App] [TaskDependencies] Processing KY3P task {"taskId":811,"taskType":"ky3p","currentProgress":0,"currentStatus":"not_started","timestamp":"2025-05-12T23:34:56.011Z"}
[UnifiedProgress] Starting progress update for task 811 (ky3p) {
  taskId: 811,
  taskType: 'ky3p',
  diagnosticId: 'prog-1747092896011-689',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 811 (ky3p)
[2025-05-12T23:34:56.077Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[KY3P Progress] Calculated progress for task 811: {
  taskId: 811,
  taskType: 'ky3p',
  normalizedTaskType: 'ky3p',
  totalFields: 120,
  completedFields: 0,
  progress: 0,
  timeStamp: '2025-05-12T23:34:56.127Z'
}
[UnifiedProgressCalc] Task 811 (ky3p) progress: 0/120 = 0%
[2025-05-12T23:34:56.157Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 5 clients {"module":"WebSocket","messageType":"task_updated","recipients":5,"totalClients":5,"filtered":false}
[2025-05-12T23:34:56.157Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":811,"messageId":"msg_1747092896156_qrm3jiba"}
[2025-05-12T23:34:56.157Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 811 {"progress":0,"status":"not_started","messageId":"msg_1747092896156_qrm3jiba"}
[2025-05-12T23:34:56.157Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":811,"taskType":"ky3p","isKy3pTask":true,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[UnifiedProgress] Starting progress update for task 812 (open_banking) {
  taskId: 812,
  taskType: 'open_banking',
  diagnosticId: 'prog-1747092896158-372',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 812 (open_banking)
[UnifiedProgressCalc] Task 812 (open_banking) progress: 0/44 = 0%
[2025-05-12T23:34:56.303Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 5 clients {"module":"WebSocket","messageType":"task_updated","recipients":5,"totalClients":5,"filtered":false}
[2025-05-12T23:34:56.303Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":812,"messageId":"msg_1747092896303_r3vevxuv"}
[2025-05-12T23:34:56.304Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 812 {"progress":0,"status":"not_started","messageId":"msg_1747092896303_r3vevxuv"}
[2025-05-12T23:34:56.304Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":812,"taskType":"open_banking","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-12T23:34:56.304Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":809,"userEmail":"30@e.com","timestamp":"2025-05-12T23:34:56.304Z"}
[2025-05-12T23:34:56.335Z] [INFO] [App] Our WebSocket server not initialized, falling back to unified implementation 
[2025-05-12T23:34:56.335Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 5 clients {"module":"WebSocket","messageType":"task_updated","recipients":5,"totalClients":5,"filtered":false}
[2025-05-12T23:34:56.335Z] [INFO] [App] Successfully broadcast task update using unified implementation {"taskId":809,"status":"completed"}
[2025-05-12T23:34:56.335Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":285,"count":4}
[Tasks] Successfully unlocked all tasks for company: 285
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 328',
    condition2: 'tasks.created_by = 328',
    condition3: "tasks.company_id = 285 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('30@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
[2025-05-12T23:34:56.427Z] [INFO] [App] GET /api/tasks 200 in 732ms :: [{"id":810,"title":"1. KYB Form: DevTest30","description":"Complete KYB verif... 
[2025-05-12T23:34:57.162Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:00.124Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:03.124Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:03.774Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092789518-3io4omo","code":1001,"reason":"","remainingClients":4}
[2025-05-12T23:35:03.774Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092791106-vmeb0wq","code":1001,"reason":"","remainingClients":3}
[2025-05-12T23:35:03.777Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092793461-xq2unrg","code":1001,"reason":"","remainingClients":2}
[2025-05-12T23:35:03.778Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092794499-fcaj0ex","code":1001,"reason":"","remainingClients":1}
[2025-05-12T23:35:03.778Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1747092788781-tyiuuma","code":1001,"reason":"","remainingClients":0}
[Auth] Returning user session data
[2025-05-12T23:35:24.717Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:24.718Z] [INFO] [App] GET /api/tasks 304 in 32ms :: [{"id":810,"title":"1. KYB Form: DevTest30","description":"Complete KYB verif... 
[2025-05-12T23:35:24.855Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092924855-8t6n3fd","clients":1}
[2025-05-12T23:35:24.894Z] [INFO] [App] GET /api/tasks 304 in 31ms :: [{"id":810,"title":"1. KYB Form: DevTest30","description":"Complete KYB verif... 
[2025-05-12T23:35:24.993Z] [INFO] [WebSocket] Received message from client client-1747092924855-8t6n3fd {"module":"WebSocket","type":"authenticate","data":{"timestamp":"2025-05-12T23:35:24.819Z"}}
[2025-05-12T23:35:24.993Z] [INFO] [WebSocket] Authentication from client client-1747092924855-8t6n3fd {"module":"WebSocket","hasToken":true}
[2025-05-12T23:35:25.345Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092925345-4e4o54w","clients":2}
[2025-05-12T23:35:25.837Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092925837-jqkzjf8","clients":3}
[2025-05-12T23:35:26.337Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092926337-aschfkd","clients":4}
[2025-05-12T23:35:26.824Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092926824-f7jkhth","clients":5}
[2025-05-12T23:35:26.940Z] [INFO] [WebSocket] Received message from client client-1747092926824-f7jkhth {"module":"WebSocket","type":"authenticate","userId":null,"companyId":null,"clientId":"ws_1747092923930_133sjaho5","timestamp":"2025-05-12T23:35:26.767Z"}
[2025-05-12T23:35:26.940Z] [INFO] [WebSocket] Authentication from client client-1747092926824-f7jkhth {"module":"WebSocket","userId":null,"companyId":null,"hasToken":true}
[2025-05-12T23:35:27.316Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1747092927316-qkemxfu","clients":6}
[Auth] Returning user session data
[2025-05-12T23:35:27.677Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:27.798Z] [INFO] [WebSocket] Received message from client client-1747092927316-qkemxfu {"module":"WebSocket","type":"authenticate","userId":328,"companyId":285,"clientId":"ws_1747092925292_ocbh2adjp","timestamp":"2025-05-12T23:35:27.623Z"}
[2025-05-12T23:35:27.798Z] [INFO] [WebSocket] Authentication from client client-1747092927316-qkemxfu {"module":"WebSocket","userId":328,"companyId":285,"hasToken":true}
[2025-05-12T23:35:27.913Z] [INFO] [App] GET /api/companies/current 304 in 36ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:30.903Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:33.906Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[Current Company] Updating company 285 with data: { numEmployees: 'small', revenueTier: '5000000' }
[Current Company] Request headers: { contentType: 'application/json', methodOverride: 'PATCH' }
[Current Company] Method override header: PATCH, treating as PATCH: true
[Current Company] Setting num_employees to: small
[Current Company] Setting revenue_tier to: 5000000
[Current Company] Parsed revenue_tier as integer: 5000000
[Current Company] Executing update with data: { num_employees: 'small', revenue_tier: 5000000 }
[Current Company] Error updating company: error: invalid input syntax for type integer: "small"
    at file:///home/runner/workspace/node_modules/@neondatabase/serverless/index.mjs:1345:74
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async NeonPreparedQuery.execute (/home/runner/workspace/node_modules/src/neon-serverless/session.ts:102:18)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:1167:32) {
  length: 148,
  severity: 'ERROR',
  code: '22P02',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: "unnamed portal parameter $1 = '...'",
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'numutils.c',
  line: '616',
  routine: 'pg_strtoint32_safe'
}
[2025-05-12T23:35:35.757Z] [ERROR] [App] POST /api/companies/current 500 in 82ms :: {"message":"Error updating company data","code":"SERVER_ERROR","details":"inv... 
[2025-05-12T23:35:36.915Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 328, company_id: 285, email: '30@e.com' }
[2025-05-12T23:35:39.873Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":285,"userId":328}
[2025-05-12T23:35:39.904Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:39.905Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":285}
[Tasks] Automatically unlocking all tasks for company { userId: 328, companyId: 285, requestedBy: 'automatic_task_unlock' }
[2025-05-12T23:35:39.906Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":285}
[2025-05-12T23:35:39.938Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":809,"userEmail":"30@e.com","currentStatus":"completed","currentProgress":100}
[2025-05-12T23:35:39.938Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":285,"count":4,"taskIds":[810,811,812,809],"taskTypes":["company_kyb","ky3p","open_banking","user_onboarding"],"ky3pTaskCount":1,"ky3pTaskIds":[811]}
[UnifiedProgress] Starting progress update for task 810 (company_kyb) {
  taskId: 810,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1747092939939-186',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 810 (company_kyb)
[UnifiedProgressCalc] Task 810 (company_kyb) progress: 0/30 = 0%
[2025-05-12T23:35:40.089Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 6 clients {"module":"WebSocket","messageType":"task_updated","recipients":6,"totalClients":6,"filtered":false}
[2025-05-12T23:35:40.090Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":810,"messageId":"msg_1747092940089_944nr8oo"}
[2025-05-12T23:35:40.090Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 810 {"progress":0,"status":"not_started","messageId":"msg_1747092940089_944nr8oo"}
[2025-05-12T23:35:40.090Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":810,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-12T23:35:40.090Z] [INFO] [App] [TaskDependencies] Processing KY3P task {"taskId":811,"taskType":"ky3p","currentProgress":0,"currentStatus":"not_started","timestamp":"2025-05-12T23:35:40.090Z"}
[UnifiedProgress] Starting progress update for task 811 (ky3p) {
  taskId: 811,
  taskType: 'ky3p',
  diagnosticId: 'prog-1747092940091-283',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 811 (ky3p)
[KY3P Progress] Calculated progress for task 811: {
  taskId: 811,
  taskType: 'ky3p',
  normalizedTaskType: 'ky3p',
  totalFields: 120,
  completedFields: 0,
  progress: 0,
  timeStamp: '2025-05-12T23:35:40.230Z'
}
[UnifiedProgressCalc] Task 811 (ky3p) progress: 0/120 = 0%
[2025-05-12T23:35:40.262Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 6 clients {"module":"WebSocket","messageType":"task_updated","recipients":6,"totalClients":6,"filtered":false}
[2025-05-12T23:35:40.262Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":811,"messageId":"msg_1747092940261_hb278ilw"}
[2025-05-12T23:35:40.262Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 811 {"progress":0,"status":"not_started","messageId":"msg_1747092940261_hb278ilw"}
[2025-05-12T23:35:40.262Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":811,"taskType":"ky3p","isKy3pTask":true,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[UnifiedProgress] Starting progress update for task 812 (open_banking) {
  taskId: 812,
  taskType: 'open_banking',
  diagnosticId: 'prog-1747092940264-359',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 812 (open_banking)
[UnifiedProgressCalc] Task 812 (open_banking) progress: 0/44 = 0%
[2025-05-12T23:35:40.415Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 6 clients {"module":"WebSocket","messageType":"task_updated","recipients":6,"totalClients":6,"filtered":false}
[2025-05-12T23:35:40.416Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":812,"messageId":"msg_1747092940415_embhdw8q"}
[2025-05-12T23:35:40.416Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 812 {"progress":0,"status":"not_started","messageId":"msg_1747092940415_embhdw8q"}
[2025-05-12T23:35:40.416Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":285,"taskId":812,"taskType":"open_banking","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-12T23:35:40.416Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":809,"userEmail":"30@e.com","timestamp":"2025-05-12T23:35:40.416Z"}
[2025-05-12T23:35:40.447Z] [INFO] [App] Our WebSocket server not initialized, falling back to unified implementation 
[2025-05-12T23:35:40.447Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 6 clients {"module":"WebSocket","messageType":"task_updated","recipients":6,"totalClients":6,"filtered":false}
[2025-05-12T23:35:40.447Z] [INFO] [App] Successfully broadcast task update using unified implementation {"taskId":809,"status":"completed"}
[2025-05-12T23:35:40.447Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":285,"count":4}
[Tasks] Successfully unlocked all tasks for company: 285
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 328',
    condition2: 'tasks.created_by = 328',
    condition3: "tasks.company_id = 285 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('30@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
[2025-05-12T23:35:40.545Z] [INFO] [App] GET /api/tasks 200 in 672ms :: [{"id":810,"title":"1. KYB Form: DevTest30","description":"Complete KYB verif... 
[2025-05-12T23:35:42.902Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:45.903Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:47.435Z] [INFO] [WebSocket] Received message from client client-1747092927316-qkemxfu {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:35:47.261Z","connectionId":"ws_1747092925292_ocbh2adjp"}
[2025-05-12T23:35:48.917Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:51.906Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:54.904Z] [INFO] [App] GET /api/companies/current 304 in 32ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-12T23:35:54.994Z] [INFO] [WebSocket] Received message from client client-1747092924855-8t6n3fd {"module":"WebSocket","type":"ping"}
[2025-05-12T23:35:55.757Z] [INFO] [App] GET /api/tasks 304 in 38ms :: [{"id":810,"title":"1. KYB Form: DevTest30","description":"Complete KYB verif... 
[2025-05-12T23:35:55.957Z] [INFO] [WebSocket] Received message from client client-1747092925837-jqkzjf8 {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:35:55.784Z","connectionId":"ws_1747092925782_oni7wrcrs"}
[2025-05-12T23:35:56.455Z] [INFO] [WebSocket] Received message from client client-1747092926337-aschfkd {"module":"WebSocket","type":"ping","timestamp":"2025-05-12T23:35:56.281Z","connectionId":"ws_1747092925288_5gxt0iepx"}
[Current Company] Fetching company for user: { userId: 328, companyId: 285 }
[Current Company] Found company: {
  id: 285,
  name: 'DevTest30',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[2025-05-12T23:35:57.938Z] [INFO] [App] GET /api/companies/current 304 in 65ms :: {"id":285,"name":"DevTest30","category":"FinTech","is_demo":true,"revenue_tie... 