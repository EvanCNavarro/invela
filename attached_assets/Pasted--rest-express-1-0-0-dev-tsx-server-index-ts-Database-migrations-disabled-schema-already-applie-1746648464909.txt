> rest-express@1.0.0 dev
> tsx server/index.ts

Database migrations disabled - schema already applied
[EmailService] Initializing email service
[EmailService] Email service initialized successfully
[OpenAI] Service initialized with API key: API key is set
Database module not found, creating a mock implementation
[Auth] Setting up authentication...
[Auth] Setting up PostgreSQL session store
[Auth] PostgreSQL session store initialized successfully
[Auth] Authentication setup completed
[2025-05-07T20:03:33.634Z] [INFO] [App] [KY3P-BATCH-UPDATE] Registering KY3P batch update routes 
[2025-05-07T20:03:33.634Z] [INFO] [App] Registering KY3P batch update routes 
[2025-05-07T20:03:33.634Z] [INFO] [App] [UnifiedKY3P] Registering unified KY3P update routes 
[Routes] Registered KY3P field key router
[Routes] Registered KY3P field key router
[2025-05-07T20:03:33.634Z] [INFO] [App] Registering KY3P field update routes 
[Routes] Setting up unified clear fields router
[Routes] Successfully registered unified clear fields router
[2025-05-07T20:03:33.636Z] [INFO] [App] [OpenBankingRoutes] Setting up routes... 
[Routes] Setting up transaction-based unified form submission router
[Routes] Successfully registered transaction-based unified form submission router
[Routes] Setting up unified form submission router
[Routes] Successfully registered unified form submission router
[Routes] Setting up transactional form submission router
[Routes] Successfully registered transactional form submission router
[Routes] Routes setup completed
[2025-05-07T20:03:33.637Z] [INFO] [App] [WebSocket] Setting up unified WebSocket server on path /ws 
[2025-05-07T20:03:33.638Z] [INFO] [WebSocket] Unified WebSocket server initialized successfully {"module":"WebSocket","clients":0,"path":"/ws","id":"n2jhrc","timestamp":"2025-05-07T20:03:33.638Z"}
[2025-05-07T20:03:33.638Z] [INFO] [App] [WebSocket] Unified WebSocket server initialized successfully 
[2025-05-07T20:03:33.638Z] [INFO] [App] Using existing unified WebSocket server 
[2025-05-07T20:03:33.638Z] [INFO] [App] [WebSocket] Legacy WebSocket server initialized successfully 
[2025-05-07T20:03:33.638Z] [INFO] [App] [ServerStartup] WebSocket server initialized with unified implementation 
[2025-05-07T20:03:33.638Z] [INFO] [App] [TaskWebSocket] WebSocket server registered with unified implementation 
[2025-05-07T20:03:33.638Z] [INFO] [App] [ServerStartup] WebSocket server registered with task-update utility 
[TaskBroadcast] WebSocket server reference set up
[TaskBroadcast] WebSocket server active with 0 connected clients
[2025-05-07T20:03:33.638Z] [INFO] [App] [ServerStartup] WebSocket server registered with task-broadcast utility 
[2025-05-07T20:03:33.639Z] [INFO] [App] Setting up Vite development server 
[ENV] Using PORT=5000 from environment (override: yes)
[ENV] Environment=development (production: no)
[2025-05-07T20:03:33.654Z] [INFO] [App] Server running on 0.0.0.0:5000 
[2025-05-07T20:03:33.654Z] [INFO] [App] Environment: development 
[Deployment] Server running on 0.0.0.0:5000
[Deployment] Environment: development
[Deployment] Port forwarding: Custom port: 5000
[Deployment] Development mode: Hot reloading enabled
[2025-05-07T20:03:33.654Z] [INFO] [App] Starting periodic task reconciliation system... 
[PeriodicTaskReconciliation] Stopped periodic reconciliation system
[PeriodicTaskReconciliation] Starting periodic reconciliation system (interval: 300000ms)
[2025-05-07T20:03:33.654Z] [INFO] [App] Task reconciliation system initialized successfully 
[2025-05-07T20:03:34.302Z] New client connected to the pool (1/3)
[2025-05-07T20:03:34.909Z] [INFO] [App] [ServerStartup] WebSocket server active with 0 connected clients 
[2025-05-07T20:03:39.285Z] New client connected to the pool (2/3)
[2025-05-07T20:03:47.483Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1746648227483-n7ow4q3","clients":1}
[Auth] Unauthenticated user session
[2025-05-07T20:03:47.779Z] [INFO] [WebSocket] Received message from client client-1746648227483-n7ow4q3 {"module":"WebSocket","type":"authenticate","data":{"timestamp":"2025-05-07T20:03:47.778Z"}}
[2025-05-07T20:03:47.779Z] [INFO] [WebSocket] Authentication from client client-1746648227483-n7ow4q3 {"module":"WebSocket","hasToken":true}
[2025-05-07T20:03:48.491Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1746648228491-esch62y","clients":2}
[Auth] Unauthenticated user session
[2025-05-07T20:03:48.534Z] [INFO] [WebSocket] Received message from client client-1746648228491-esch62y {"module":"WebSocket","type":"authenticate","userId":null,"companyId":null,"clientId":"ws_1746648228481_shhpf33mv","timestamp":"2025-05-07T20:03:48.532Z"}
[2025-05-07T20:03:48.534Z] [INFO] [WebSocket] Authentication from client client-1746648228491-esch62y {"module":"WebSocket","userId":null,"companyId":null,"hasToken":true}
[2025-05-07T20:03:48.715Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1746648227483-n7ow4q3","code":1001,"reason":"","remainingClients":1}
[2025-05-07T20:03:48.716Z] [INFO] [WebSocket] Client disconnected {"module":"WebSocket","clientId":"client-1746648228491-esch62y","code":1001,"reason":"","remainingClients":0}
[PeriodicTaskReconciliation] Reconciling batch of 10 tasks: [
  679, 685, 691, 690,
  707, 689, 698, 759,
  766, 722
]
[2025-05-07T20:04:03.790Z] New client connected to the pool (3/3)
[Task Progress] Calculated progress for task 679 (open_banking): 44/44 = 100%
[Task Progress] Calculated progress for task 685 (company_kyb): 30/30 = 100%
[Task Progress] Calculated progress for task 691 (open_banking): 0/44 = 0%
[Task Progress] Calculated progress for task 690 (ky3p): 0/120 = 0%
[Task Progress] Calculated progress for task 707 (open_banking): 0/44 = 0%
[Task Progress] Calculated progress for task 689 (company_kyb): 30/30 = 100%
[Task Progress] Calculated progress for task 698 (ky3p): 0/0 = 0%
[Task Progress] Calculated progress for task 759 (ky3p): 0/0 = 0%
[Task Progress] Calculated progress for task 766 (company_kyb): 0/30 = 0%
[Task Progress] Calculated progress for task 722 (company_kyb): 30/30 = 100%
[Auth] Returning user session data
[Current Company] Fetching company for user: { userId: 316, companyId: 273 }
[Current Company] Found company: {
  id: 273,
  name: 'DevTest18',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 316, company_id: 273, email: '18@e.com' }
[2025-05-07T20:04:15.057Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":273,"userId":316}
[2025-05-07T20:04:15.086Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":273}
[Tasks] Automatically unlocking all tasks for company { userId: 316, companyId: 273, requestedBy: 'automatic_task_unlock' }
[2025-05-07T20:04:15.087Z] [INFO] [App] GET /api/companies/current 304 in 64ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:15.088Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":273}
[2025-05-07T20:04:15.119Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":761,"userEmail":"18@e.com","currentStatus":"completed","currentProgress":100}
[TaskDependencies] Skipping task 763 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[TaskDependencies] Skipping task 764 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[2025-05-07T20:04:15.120Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":273,"count":2,"taskIds":[761,762],"taskTypes":["user_onboarding","company_kyb"],"ky3pTaskCount":0,"ky3pTaskIds":[]}
[2025-05-07T20:04:15.120Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":761,"userEmail":"18@e.com","timestamp":"2025-05-07T20:04:15.120Z"}
[2025-05-07T20:04:15.151Z] [INFO] [App] Our WebSocket server not initialized, falling back to unified implementation 
[2025-05-07T20:04:15.151Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 0 clients {"module":"WebSocket","messageType":"task_updated","recipients":0,"totalClients":0,"filtered":false}
[2025-05-07T20:04:15.151Z] [INFO] [App] Successfully broadcast task update using unified implementation {"taskId":761,"status":"completed"}
[UnifiedProgress] Starting progress update for task 762 (company_kyb) {
  taskId: 762,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1746648255152-424',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[2025-05-07T20:04:15.159Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1746648255159-yelkhf8","clients":1}
[UnifiedProgressCalc] Calculating progress for task 762 (company_kyb)
[UnifiedProgressCalc] Task 762 (company_kyb) progress: 0/30 = 0%
[2025-05-07T20:04:15.306Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 1 clients {"module":"WebSocket","messageType":"task_updated","recipients":1,"totalClients":1,"filtered":false}
[2025-05-07T20:04:15.306Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":762,"messageId":"msg_1746648255305_ig7xhr5g"}
[2025-05-07T20:04:15.306Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 762 {"progress":0,"status":"not_started","messageId":"msg_1746648255305_ig7xhr5g"}
[2025-05-07T20:04:15.306Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":273,"taskId":762,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-07T20:04:15.306Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":273,"count":2}
[Tasks] Successfully unlocked all tasks for company: 273
[2025-05-07T20:04:15.307Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:15.320Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"authenticate","data":{"timestamp":"2025-05-07T20:04:15.049Z"}}
[2025-05-07T20:04:15.320Z] [INFO] [WebSocket] Authentication from client client-1746648255159-yelkhf8 {"module":"WebSocket","hasToken":true}
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 316',
    condition2: 'tasks.created_by = 316',
    condition3: "tasks.company_id = 273 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('18@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
[2025-05-07T20:04:15.410Z] [INFO] [App] GET /api/tasks 200 in 355ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:04:15.568Z] [INFO] [App] GET /api/tasks 304 in 31ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:04:15.735Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1746648255735-74opaes","clients":2}
[2025-05-07T20:04:15.998Z] [INFO] [WebSocket] Received message from client client-1746648255735-74opaes {"module":"WebSocket","type":"authenticate","userId":null,"companyId":null,"clientId":"ws_1746648254473_0hesz10mw","timestamp":"2025-05-07T20:04:15.758Z"}
[2025-05-07T20:04:15.998Z] [INFO] [WebSocket] Authentication from client client-1746648255735-74opaes {"module":"WebSocket","userId":null,"companyId":null,"hasToken":true}
[2025-05-07T20:04:17.045Z] [INFO] [WebSocket] Client connected {"module":"WebSocket","clientId":"client-1746648257045-vblo398","clients":3}
[Auth] Returning user session data
[2025-05-07T20:04:17.458Z] [INFO] [App] GET /api/companies/current 304 in 36ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:17.593Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"authenticate","userId":316,"companyId":273,"clientId":"ws_1746648256404_te26x8e7z","timestamp":"2025-05-07T20:04:17.350Z"}
[2025-05-07T20:04:17.593Z] [INFO] [WebSocket] Authentication from client client-1746648257045-vblo398 {"module":"WebSocket","userId":316,"companyId":273,"hasToken":true}
[2025-05-07T20:04:18.710Z] [INFO] [App] GET /api/companies/current 304 in 39ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:21.699Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:24.716Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:27.721Z] [INFO] [App] GET /api/companies/current 304 in 40ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:30.696Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:33.699Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:36.705Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:37.629Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:04:37.398Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:04:39.769Z] [INFO] [App] GET /api/companies/current 304 in 33ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Current Company] Using cached company data: 273
[2025-05-07T20:04:42.695Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:45.630Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:04:45.691Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:04:57.631Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:04:57.400Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:05:15.634Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:05:17.630Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:05:17.399Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:05:37.628Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:05:37.398Z","connectionId":"ws_1746648256404_te26x8e7z"}
[Current Company] Fetching company for user: { userId: 316, companyId: 273 }
[Current Company] Found company: {
  id: 273,
  name: 'DevTest18',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[2025-05-07T20:05:38.739Z] [INFO] [App] GET /api/companies/current 304 in 62ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:05:45.630Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:05:57.635Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:05:57.398Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:06:15.628Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:06:16.663Z] [INFO] [WebSocket] Received message from client client-1746648255735-74opaes {"module":"WebSocket","type":"ping"}
[2025-05-07T20:06:17.633Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:06:17.403Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:06:24.348Z] [INFO] [App] GET /api/companies/current 304 in 35ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
Suppressing further connection logs. Pool size: 3
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 316, company_id: 273, email: '18@e.com' }
[2025-05-07T20:06:24.485Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":273,"userId":316}
[2025-05-07T20:06:24.519Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":273}
[Tasks] Automatically unlocking all tasks for company { userId: 316, companyId: 273, requestedBy: 'automatic_task_unlock' }
[2025-05-07T20:06:24.528Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":273}
[2025-05-07T20:06:24.532Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:24.557Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":761,"userEmail":"18@e.com","currentStatus":"completed","currentProgress":100}
[TaskDependencies] Skipping task 763 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[TaskDependencies] Skipping task 764 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[2025-05-07T20:06:24.558Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":273,"count":2,"taskIds":[761,762],"taskTypes":["user_onboarding","company_kyb"],"ky3pTaskCount":0,"ky3pTaskIds":[]}
[2025-05-07T20:06:24.558Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":761,"userEmail":"18@e.com","timestamp":"2025-05-07T20:06:24.558Z"}
[2025-05-07T20:06:24.589Z] [DEBUG] [App] Broadcasting task update with object format {"taskId":761,"status":"completed"}
[WebSocket] Broadcast task_update to 3 clients (0 errors) { messageId: 'msg_1746648384590_rjaux0yq3' }
[2025-05-07T20:06:24.590Z] [INFO] [App] Successfully broadcasted task_update message 
[UnifiedProgress] Starting progress update for task 762 (company_kyb) {
  taskId: 762,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1746648384591-671',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 762 (company_kyb)
[UnifiedProgressCalc] Task 762 (company_kyb) progress: 0/30 = 0%
[2025-05-07T20:06:24.738Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 3 clients {"module":"WebSocket","messageType":"task_updated","recipients":3,"totalClients":3,"filtered":false}
[2025-05-07T20:06:24.738Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":762,"messageId":"msg_1746648384738_rk4qczrn"}
[2025-05-07T20:06:24.738Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 762 {"progress":0,"status":"not_started","messageId":"msg_1746648384738_rk4qczrn"}
[2025-05-07T20:06:24.738Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":273,"taskId":762,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-07T20:06:24.738Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":273,"count":2}
[Tasks] Successfully unlocked all tasks for company: 273
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 316',
    condition2: 'tasks.created_by = 316',
    condition3: "tasks.company_id = 273 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('18@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
[2025-05-07T20:06:24.835Z] [INFO] [App] GET /api/tasks 200 in 350ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:06:27.310Z] [INFO] [App] GET /api/companies/current 304 in 35ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:30.306Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:33.310Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:36.315Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:37.087Z] [INFO] [App] GET /api/tasks 304 in 30ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:06:37.091Z] [INFO] [App] GET /api/companies/current 304 in 29ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:37.164Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:06:36.933Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:06:37.249Z] [INFO] [App] GET /api/tasks/763 200 in 61ms :: {"id":763,"title":"2. S&P KY3P Security Assessment: DevTest18","description":... 
[2025-05-07T20:06:38.591Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Auth] Returning user session data
[Task Templates API] Fetching template for task type: ky3p, user: 316
[Task Templates API] Found template: 48 (S&P KY3P Security Assessment) for task type: ky3p
[2025-05-07T20:06:38.713Z] [INFO] [App] GET /api/tasks/763 304 in 66ms :: {"id":763,"title":"2. S&P KY3P Security Assessment: DevTest18","description":... 
[Task Templates API] Retrieved 10 configuration items for template ID: 48
[2025-05-07T20:06:38.756Z] [INFO] [App] GET /api/task-templates/by-type/ky3p 304 in 107ms :: {"id":48,"name":"S&P KY3P Security Assessment","description":"S&P KY3P Securi... 
[2025-05-07T20:06:38.913Z] [INFO] [App] Fetching all KY3P fields 
[2025-05-07T20:06:39.004Z] [INFO] [App] Successfully retrieved 120 KY3P fields 
[2025-05-07T20:06:39.043Z] [INFO] [App] GET /api/ky3p-fields 304 in 130ms :: [{"id":1,"order":1,"field_key":"externalSystems","display_name":"External Sys... 
[2025-05-07T20:06:39.536Z] [INFO] [App] Fetching KY3P progress for task 763 
[2025-05-07T20:06:39.626Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:39.717Z] [INFO] [App] GET /api/ky3p/progress/763 200 in 180ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:40.761Z] [INFO] [App] Fetching KY3P progress for task 763 
[Current Company] Fetching company for user: { userId: 316, companyId: 273 }
[Current Company] Found company: {
  id: 273,
  name: 'DevTest18',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
[2025-05-07T20:06:40.827Z] [INFO] [App] GET /api/companies/current 304 in 60ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:40.847Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:40.939Z] [INFO] [App] GET /api/ky3p/progress/763 304 in 177ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:42.465Z] [INFO] [App] GET /api/tasks/763 304 in 61ms :: {"id":763,"title":"2. S&P KY3P Security Assessment: DevTest18","description":... 
[2025-05-07T20:06:42.642Z] [INFO] [App] Fetching KY3P responses for task 763 
[2025-05-07T20:06:42.692Z] [INFO] [App] GET /api/tasks/763 304 in 61ms :: {"id":763,"title":"2. S&P KY3P Security Assessment: DevTest18","description":... 
[2025-05-07T20:06:42.727Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:42.758Z] [INFO] [App] GET /api/tasks/763/ky3p-responses 200 in 116ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:42.931Z] [INFO] [App] Fetching KY3P responses for task 763 
[2025-05-07T20:06:42.991Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:43.022Z] [INFO] [App] GET /api/tasks/763/ky3p-responses 304 in 90ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:43.150Z] [INFO] [App] Fetching KY3P progress for task 763 
[2025-05-07T20:06:43.209Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:43.305Z] [INFO] [App] GET /api/ky3p/progress/763 304 in 154ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:43.465Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:43.474Z] [INFO] [App] Fetching KY3P progress for task 763 
[2025-05-07T20:06:43.559Z] [INFO] [App] Retrieved 120 responses for task 763 
[2025-05-07T20:06:43.657Z] [INFO] [App] GET /api/ky3p/progress/763 304 in 182ms :: {"success":true,"taskId":763,"status":"ready_for_submission","responses":[{"i... 
[2025-05-07T20:06:45.282Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:06:46.468Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:47.830Z] [INFO] [App] [UnifiedClear] Processing clear request {"taskId":763,"userId":316,"companyId":273,"formType":"ky3p","preserveProgress":true}
[2025-05-07T20:06:47.831Z] [INFO] [App] [UnifiedClear] Clearing fields for ky3p task {"taskId":763,"userId":316,"companyId":273,"formType":"ky3p","preserveProgress":true,"responseTable":"ky3p_responses"}
[2025-05-07T20:06:47.954Z] [INFO] [App] [UnifiedClear] Deleted responses {"taskId":763,"formType":"ky3p","responseTable":"ky3p_responses","count":120}
[2025-05-07T20:06:47.954Z] [INFO] [App] [UnifiedClear] Updating task status {"taskId":763,"formType":"ky3p","newStatus":"ready_for_submission","newProgress":100,"currentStatus":"ready_for_submission","currentProgress":100,"preserveProgress":true,"timestamp":"2025-05-07T20:06:47.954Z"}
[2025-05-07T20:06:48.016Z] [INFO] [App] [UnifiedClear] Successfully cleared ky3p task fields {"taskId":763,"formType":"ky3p","status":"ready_for_submission","progress":100,"preserveProgress":true}
[2025-05-07T20:06:48.016Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 3 clients {"module":"WebSocket","messageType":"task_updated","recipients":3,"totalClients":3,"filtered":false}
[2025-05-07T20:06:48.017Z] [INFO] [App] [UnifiedClear] Successfully broadcast task update {"taskId":763,"formType":"ky3p","status":"ready_for_submission","progress":100}
[2025-05-07T20:06:48.047Z] [INFO] [App] POST /api/ky3p/clear/763 200 in 217ms :: {"success":true,"message":"ky3p fields cleared successfully","taskId":763,"st... 
[2025-05-07T20:06:48.591Z] [INFO] [App] [UnifiedClear] Processing clear request {"taskId":763,"userId":316,"companyId":273,"formType":"ky3p","preserveProgress":true}
[2025-05-07T20:06:48.592Z] [INFO] [App] [UnifiedClear] Clearing fields for ky3p task {"taskId":763,"userId":316,"companyId":273,"formType":"ky3p","preserveProgress":true,"responseTable":"ky3p_responses"}
[2025-05-07T20:06:48.681Z] [INFO] [App] [UnifiedClear] Deleted responses {"taskId":763,"formType":"ky3p","responseTable":"ky3p_responses","count":0}
[2025-05-07T20:06:48.681Z] [INFO] [App] [UnifiedClear] Updating task status {"taskId":763,"formType":"ky3p","newStatus":"ready_for_submission","newProgress":100,"currentStatus":"ready_for_submission","currentProgress":100,"preserveProgress":true,"timestamp":"2025-05-07T20:06:48.681Z"}
[2025-05-07T20:06:48.747Z] [INFO] [App] [UnifiedClear] Successfully cleared ky3p task fields {"taskId":763,"formType":"ky3p","status":"ready_for_submission","progress":100,"preserveProgress":true}
[2025-05-07T20:06:48.747Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 3 clients {"module":"WebSocket","messageType":"task_updated","recipients":3,"totalClients":3,"filtered":false}
[2025-05-07T20:06:48.747Z] [INFO] [App] [UnifiedClear] Successfully broadcast task update {"taskId":763,"formType":"ky3p","status":"ready_for_submission","progress":100}
[2025-05-07T20:06:48.779Z] [INFO] [App] POST /api/ky3p/clear/763 200 in 188ms :: {"success":true,"message":"ky3p fields cleared successfully","taskId":763,"st... 
[2025-05-07T20:06:49.470Z] [INFO] [App] GET /api/companies/current 304 in 36ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:52.461Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Current Company] Using cached company data: 273
[2025-05-07T20:06:55.457Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:06:57.168Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:06:56.934Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:06:58.466Z] [INFO] [App] GET /api/companies/current 304 in 29ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:01.459Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 316, company_id: 273, email: '18@e.com' }
[2025-05-07T20:07:03.001Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":273,"userId":316}
[2025-05-07T20:07:03.031Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":273}
[Tasks] Automatically unlocking all tasks for company { userId: 316, companyId: 273, requestedBy: 'automatic_task_unlock' }
[2025-05-07T20:07:03.032Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":273}
[2025-05-07T20:07:03.040Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:03.061Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":761,"userEmail":"18@e.com","currentStatus":"completed","currentProgress":100}
[TaskDependencies] Skipping task 763 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[TaskDependencies] Skipping task 764 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[2025-05-07T20:07:03.061Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":273,"count":2,"taskIds":[761,762],"taskTypes":["user_onboarding","company_kyb"],"ky3pTaskCount":0,"ky3pTaskIds":[]}
[2025-05-07T20:07:03.061Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":761,"userEmail":"18@e.com","timestamp":"2025-05-07T20:07:03.061Z"}
[2025-05-07T20:07:03.091Z] [DEBUG] [App] Broadcasting task update with object format {"taskId":761,"status":"completed"}
[WebSocket] Broadcast task_update to 3 clients (0 errors) { messageId: 'msg_1746648423091_uk23r23xg' }
[2025-05-07T20:07:03.092Z] [INFO] [App] Successfully broadcasted task_update message 
[UnifiedProgress] Starting progress update for task 762 (company_kyb) {
  taskId: 762,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1746648423092-469',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 762 (company_kyb)
[UnifiedProgressCalc] Task 762 (company_kyb) progress: 0/30 = 0%
[2025-05-07T20:07:03.237Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 3 clients {"module":"WebSocket","messageType":"task_updated","recipients":3,"totalClients":3,"filtered":false}
[2025-05-07T20:07:03.237Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":762,"messageId":"msg_1746648423236_s5fmg44t"}
[2025-05-07T20:07:03.237Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 762 {"progress":0,"status":"not_started","messageId":"msg_1746648423236_s5fmg44t"}
[2025-05-07T20:07:03.237Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":273,"taskId":762,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-07T20:07:03.237Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":273,"count":2}
[Tasks] Successfully unlocked all tasks for company: 273
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 316',
    condition2: 'tasks.created_by = 316',
    condition3: "tasks.company_id = 273 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('18@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }
[2025-05-07T20:07:03.330Z] [INFO] [App] GET /api/tasks 200 in 330ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:07:03.498Z] [INFO] [App] GET /api/tasks 304 in 31ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:07:03.682Z] [INFO] [App] GET /api/tasks 304 in 31ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:07:06.041Z] [INFO] [App] GET /api/companies/current 304 in 34ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:09.057Z] [INFO] [App] GET /api/companies/current 304 in 35ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:12.043Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:15.037Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:15.283Z] [INFO] [WebSocket] Received message from client client-1746648255159-yelkhf8 {"module":"WebSocket","type":"ping"}
[2025-05-07T20:07:17.166Z] [INFO] [WebSocket] Received message from client client-1746648257045-vblo398 {"module":"WebSocket","type":"ping","timestamp":"2025-05-07T20:07:16.933Z","connectionId":"ws_1746648256404_te26x8e7z"}
[2025-05-07T20:07:18.045Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Tasks] Using cached task data for user: 316
[2025-05-07T20:07:18.688Z] [INFO] [App] GET /api/tasks 304 in 33ms :: [{"id":761,"title":"New User Invitation: 18@e.com","description":"Complete us... 
[2025-05-07T20:07:21.042Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:24.037Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:27.128Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:30.039Z] [INFO] [App] GET /api/companies/current 304 in 31ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[2025-05-07T20:07:33.050Z] [INFO] [App] GET /api/companies/current 304 in 30ms :: {"id":273,"name":"DevTest18","category":"FinTech","is_demo":true,"revenue_tie... 
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 316, company_id: 273, email: '18@e.com' }
[2025-05-07T20:07:33.844Z] [INFO] [App] Performing dynamic task unlocking check for company {"companyId":273,"userId":316}
[2025-05-07T20:07:33.872Z] [INFO] [App] No completed KYB tasks found, skipping security task unlock check {"companyId":273}
[Tasks] Automatically unlocking all tasks for company { userId: 316, companyId: 273, requestedBy: 'automatic_task_unlock' }
[2025-05-07T20:07:33.873Z] [INFO] [App] [TaskDependencies] Unlocking ALL tasks for company {"companyId":273}
[2025-05-07T20:07:33.904Z] [INFO] [App] [TaskDependencies] Found user onboarding task that needs completion {"taskId":761,"userEmail":"18@e.com","currentStatus":"completed","currentProgress":100}
[TaskDependencies] Skipping task 763 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[TaskDependencies] Skipping task 764 with submission indicators {
  hasSubmissionDate: false,
  hasSubmittedFlag: false,
  hasFileId: false,
  status: 'ready_for_submission',
  progress: 100,
  isReadyForSubmission: true
}
[2025-05-07T20:07:33.905Z] [INFO] [App] [TaskDependencies] Found tasks to unlock {"companyId":273,"count":2,"taskIds":[761,762],"taskTypes":["user_onboarding","company_kyb"],"ky3pTaskCount":0,"ky3pTaskIds":[]}
[2025-05-07T20:07:33.905Z] [INFO] [App] [TaskDependencies] Setting User Onboarding task as completed {"taskId":761,"userEmail":"18@e.com","timestamp":"2025-05-07T20:07:33.905Z"}
[2025-05-07T20:07:33.935Z] [DEBUG] [App] Broadcasting task update with object format {"taskId":761,"status":"completed"}
[WebSocket] Broadcast task_update to 3 clients (0 errors) { messageId: 'msg_1746648453935_gqwgdnxes' }
[2025-05-07T20:07:33.935Z] [INFO] [App] Successfully broadcasted task_update message 
[UnifiedProgress] Starting progress update for task 762 (company_kyb) {
  taskId: 762,
  taskType: 'company_kyb',
  diagnosticId: 'prog-1746648453936-361',
  metadata: [
    'locked',
    'prerequisite_completed',
    'prerequisite_completed_at',
    'dependencyUnlockOperation',
    'previousProgress',
    'previousStatus',
    'isKy3pTask',
    'isUserOnboardingTask'
  ]
}
[UnifiedProgressCalc] Calculating progress for task 762 (company_kyb)
[UnifiedProgressCalc] Task 762 (company_kyb) progress: 0/30 = 0%
[2025-05-07T20:07:34.085Z] [INFO] [WebSocket] Broadcast message of type 'task_updated' sent to 3 clients {"module":"WebSocket","messageType":"task_updated","recipients":3,"totalClients":3,"filtered":false}
[2025-05-07T20:07:34.085Z] [DEBUG] [App] [UnifiedProgressCalc] Successfully broadcast task update using unified implementation {"taskId":762,"messageId":"msg_1746648454084_baa8koat"}
[2025-05-07T20:07:34.085Z] [INFO] [App] [UnifiedProgressCalc] Successfully broadcast task update for task 762 {"progress":0,"status":"not_started","messageId":"msg_1746648454084_baa8koat"}
[2025-05-07T20:07:34.085Z] [INFO] [App] [TaskDependencies] Unlocked task using unified progress calculator {"companyId":273,"taskId":762,"taskType":"company_kyb","isKy3pTask":false,"calculatedProgress":0,"previousProgress":0,"wasPreserved":false}
[2025-05-07T20:07:34.085Z] [INFO] [App] [TaskDependencies] Successfully unlocked all tasks {"companyId":273,"count":2}
[Tasks] Successfully unlocked all tasks for company: 273
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 316',
    condition2: 'tasks.created_by = 316',
    condition3: "tasks.company_id = 273 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('18@e.com')"
  }
}
[Tasks] Tasks found: { count: 4 }