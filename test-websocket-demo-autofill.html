<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Demo Auto-Fill Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.5;
    }
    h1, h2 {
      color: #2563eb;
    }
    .controls {
      margin: 20px 0;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    #output {
      height: 400px;
      overflow-y: auto;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: monospace;
    }
    .message {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
    }
    .info {
      background-color: #dbeafe;
      border-left: 4px solid #3b82f6;
    }
    .success {
      background-color: #dcfce7;
      border-left: 4px solid #22c55e;
    }
    .error {
      background-color: #fee2e2;
      border-left: 4px solid #ef4444;
    }
    .received {
      background-color: #f3f4f6;
      border-left: 4px solid #6b7280;
    }
    .field-update {
      background-color: #fef3c7;
      border-left: 4px solid #f59e0b;
    }
    .progress-update {
      background-color: #e0f2fe;
      border-left: 4px solid #0ea5e9;
    }
    .task-update {
      background-color: #ede9fe;
      border-left: 4px solid #8b5cf6;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
    }
    input, select {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h1>WebSocket Demo Auto-Fill Test</h1>
  
  <div class="card">
    <h2>Status</h2>
    <div id="status">Disconnected</div>
  </div>
  
  <div class="controls card">
    <h2>Controls</h2>
    
    <div>
      <label for="task-id">Task ID</label>
      <input type="number" id="task-id" value="639">
    </div>
    
    <div>
      <label for="form-type">Form Type</label>
      <select id="form-type">
        <option value="kyb">KYB</option>
        <option value="ky3p">KY3P</option>
        <option value="open_banking" selected>Open Banking</option>
      </select>
    </div>
    
    <div>
      <label for="company-name">Company Name</label>
      <input type="text" id="company-name" value="DevTest32">
    </div>
    
    <button id="connect">Connect WebSocket</button>
    <button id="disconnect" disabled>Disconnect WebSocket</button>
    <button id="test-demo-autofill" disabled>Test Demo Auto-Fill</button>
    <button id="clear-output">Clear Output</button>
  </div>
  
  <div class="card">
    <h2>WebSocket Output</h2>
    <div id="output"></div>
  </div>
  
  <script>
    let ws = null;
    
    const statusElement = document.getElementById('status');
    const outputElement = document.getElementById('output');
    const connectButton = document.getElementById('connect');
    const disconnectButton = document.getElementById('disconnect');
    const testDemoAutofillButton = document.getElementById('test-demo-autofill');
    const clearOutputButton = document.getElementById('clear-output');
    const taskIdInput = document.getElementById('task-id');
    const formTypeSelect = document.getElementById('form-type');
    const companyNameInput = document.getElementById('company-name');
    
    // Add message to output
    function log(message, type = 'info') {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${type}`;
      
      // Format message if it's an object
      if (typeof message === 'object') {
        try {
          message = JSON.stringify(message, null, 2);
        } catch (e) {
          message = String(message);
        }
      }
      
      messageElement.textContent = message;
      outputElement.appendChild(messageElement);
      outputElement.scrollTop = outputElement.scrollHeight;
    }
    
    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      log(`Connecting to WebSocket at: ${wsUrl}`);
      
      try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function(event) {
          statusElement.textContent = 'Connected';
          statusElement.style.color = 'green';
          
          connectButton.disabled = true;
          disconnectButton.disabled = false;
          testDemoAutofillButton.disabled = false;
          
          log('WebSocket connection established', 'success');
        };
        
        ws.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            
            // Determine message type
            let messageType = 'received';
            
            if (data.type === 'field_updated') {
              messageType = 'field-update';
            } else if (data.type === 'progress_update') {
              messageType = 'progress-update';
            } else if (data.type === 'task_updated') {
              messageType = 'task-update';
            }
            
            log(`Received message: ${event.data}`, messageType);
            
            // Send pong in response to ping
            if (data.type === 'ping') {
              ws.send(JSON.stringify({ type: 'pong' }));
              log('Sent pong response', 'info');
            }
          } catch (e) {
            log(`Raw message received: ${event.data}`, 'received');
          }
        };
        
        ws.onerror = function(error) {
          log(`WebSocket error: ${error.message || 'Unknown error'}`, 'error');
          statusElement.textContent = 'Error';
          statusElement.style.color = 'red';
        };
        
        ws.onclose = function(event) {
          log(`WebSocket connection closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`, 'info');
          statusElement.textContent = 'Disconnected';
          statusElement.style.color = 'red';
          
          connectButton.disabled = false;
          disconnectButton.disabled = true;
          testDemoAutofillButton.disabled = true;
        };
      } catch (error) {
        log(`Failed to connect: ${error.message}`, 'error');
      }
    }
    
    // Disconnect WebSocket
    function disconnectWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        log('WebSocket connection closed by user', 'info');
      }
    }
    
    // Test demo auto-fill
    function testDemoAutofill() {
      const taskId = taskIdInput.value;
      const formType = formTypeSelect.value;
      const companyName = companyNameInput.value;
      
      if (!taskId) {
        log('Task ID is required', 'error');
        return;
      }
      
      log(`Testing demo auto-fill for task ${taskId} with form type ${formType}`, 'info');
      
      const url = `/api/test-demo-autofill/test/${taskId}/${formType}`;
      
      // Send API request to test demo auto-fill
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          companyName: companyName
        })
      })
      .then(response => response.json())
      .then(data => {
        log(`API Response:`, 'info');
        log(data, 'success');
      })
      .catch(error => {
        log(`API Error: ${error.message}`, 'error');
      });
    }
    
    // Event Listeners
    connectButton.addEventListener('click', connectWebSocket);
    disconnectButton.addEventListener('click', disconnectWebSocket);
    testDemoAutofillButton.addEventListener('click', testDemoAutofill);
    clearOutputButton.addEventListener('click', () => {
      outputElement.innerHTML = '';
    });
    
    // Auto-connect when the page loads
    window.addEventListener('load', connectWebSocket);
  </script>
</body>
</html>