> rest-express@1.0.0 dev
> tsx server/index.ts

Database migrations disabled - schema already applied
[EmailService] Initializing email service
[EmailService] Email service initialized successfully
[OpenAI] Service initialized with API key: API key is set
[Auth] Setting up authentication...
[Auth] Authentication setup completed
[2025-04-25T19:06:35.426Z] [INFO] [OpenBankingRoutes] [OpenBankingRoutes] Setting up routes...
[Routes] Routes setup completed
[WebSocket] Server initialized on path: /ws
7:06:35 PM [info] Setting up Vite development server
7:06:35 PM [express] Server running on port 5000
New WebSocket client connected
[2025-04-25T19:06:37.242Z] New client connected to the pool (1/3)
New WebSocket client connected
[Auth] Deserializing user: 286
[Current Company] Fetching company for user: { userId: 286, companyId: 244 }
[Current Company] Found company: {
  id: 244,
  name: 'DevTest33',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
7:06:37 PM [info] GET /api/companies/current 304 in 226ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
New WebSocket client connected
New WebSocket client connected
New WebSocket client connected
7:06:40 PM [warn] POST /api/ky3p/demo-autofill/646 401 in 2ms :: {"error":"Unauthorized","message":"Authentication required","details":{"authe...
7:06:47 PM [info] GET /api/companies/current 304 in 39ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
[2025-04-25T19:06:54.768Z] New client connected to the pool (2/3)
[2025-04-25T19:06:54.768Z] New client connected to the pool (3/3)
[Auth] Using cached user data: 286
[Auth] Unauthenticated user session
New WebSocket client connected
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
WebSocket client disconnected with code 1001 and reason: 
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Using cached user data: 286
[Auth] Returning user session data
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 286, company_id: 244, email: '33@e.com' }
[2025-04-25T19:07:02.463Z] [INFO] [KYBRoutes] Performing dynamic task unlocking check for company {"companyId":244,"userId":286}
[Tasks Routes] Fetching task by ID (special .json endpoint): {
  taskId: 646,
  userCompanyId: 244,
  timestamp: '2025-04-25T19:07:02.470Z'
}
[2025-04-25T19:07:02.499Z] [INFO] [KYBRoutes] Found completed KYB tasks, checking security tasks to unlock {"companyId":244,"kybTaskCount":1}
7:07:02 PM [info] GET /api/companies/current 304 in 40ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[Tasks Routes] Task found by ID (special .json endpoint): {
  taskId: 646,
  title: '2. S&P KY3P Security Assessment: DevTest33',
  type: 'ky3p',
  formDataFields: 0,
  timestamp: '2025-04-25T19:07:02.525Z'
}
[2025-04-25T19:07:02.538Z] [INFO] [KYBRoutes] No security tasks found for company {"companyId":244}
[Tasks] Automatically unlocking all tasks for company { userId: 286, companyId: 244, requestedBy: 'automatic_task_unlock' }
[2025-04-25T19:07:02.543Z] [INFO] [TaskDependencies] [TaskDependencies] Unlocking ALL tasks for company {"companyId":244}
7:07:02 PM [info] GET /api/tasks.json/646 304 in 89ms :: {"id":646,"title":"2. S&P KY3P Security Assessment: DevTest33","description":...
[2025-04-25T19:07:02.578Z] [INFO] [TaskDependencies] [TaskDependencies] Found tasks to unlock {"companyId":244,"count":1,"taskIds":[647],"taskTypes":["open_banking"]}
[2025-04-25T19:07:02.614Z] [INFO] [TaskDependencies] [TaskDependencies] Unlocked task {"companyId":244,"taskId":647,"taskType":"open_banking"}
[WebSocket] Broadcast "task_updated" sent to 0 clients {
  type: 'task_updated',
  dataKeys: [ 'id', 'status', 'metadata', 'timestamp' ],
  timestamp: '2025-04-25T19:07:02.615Z',
  clientCount: 0
}
[2025-04-25T19:07:02.615Z] [INFO] [TaskDependencies] [TaskDependencies] Successfully unlocked all tasks {"companyId":244,"count":1}
[Tasks] Successfully unlocked all tasks for company: 244
[Tasks] KYB tasks found: { count: 1 }
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 286',
    condition2: 'tasks.created_by = 286',
    condition3: "tasks.company_id = 244 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('33@e.com')"
  }
}
New WebSocket client connected
[Tasks] Tasks found: { count: 4 }
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:07:02.733Z' }
7:07:02 PM [info] GET /api/tasks 200 in 283ms :: [{"id":644,"title":"New User Invitation: 33@e.com","description":"Complete us...
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Task Templates API] Fetching template for task type: ky3p, user: 286
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:07:02.798Z'
}
[Task Templates API] Found template: 48 (S&P KY3P Security Assessment) for task type: ky3p
7:07:02 PM [info] POST /api/tasks/646/update-progress 200 in 102ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
[Task Templates API] Retrieved 10 configuration items for template ID: 48
7:07:02 PM [info] GET /api/task-templates/by-type/ky3p 304 in 105ms :: {"id":48,"name":"S&P KY3P Security Assessment","description":"S&P KY3P Securi...
7:07:02 PM [info] GET /api/tasks 304 in 31ms :: [{"id":644,"title":"New User Invitation: 33@e.com","description":"Complete us...
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:07:03.073Z' }
[Auth] Using cached user data: 286
[2025-04-25T19:07:03.078Z] [INFO] [KY3PRoutes] [KY3P API] Fetching KY3P fields. User authenticated: true
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:07:03.133Z'
}
7:07:03 PM [info] POST /api/tasks/646/update-progress 200 in 93ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
New WebSocket client connected
[2025-04-25T19:07:03.203Z] [INFO] [KY3PRoutes] [KY3P API] Successfully retrieved 120 KY3P fields
[2025-04-25T19:07:03.203Z] [INFO] [KY3PRoutes] [KY3P API] Fields grouped by step: ["Step 0: 120 fields"]
7:07:03 PM [info] GET /api/ky3p-fields 304 in 162ms :: [{"id":1,"order":1,"field_key":"externalSystems","display_name":"External Sys...
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:07:03.400Z' }
[KYB API Debug] Loading progress for task: 646
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:07:03.469Z'
}
[KYB API Debug] Retrieved task: {
  taskId: 646,
  status: 'submitted',
  progress: 100,
  metadata: [
    'locked',
    'company_id',
    'created_at',
    'created_via',
    'status_flow',
    'company_name',
    'last_updated',
    'created_by_id',
    'progressHistory',
    'prerequisite_for',
    'prerequisite_task_id',
    'prerequisite_completed',
    'prerequisite_task_type',
    'prerequisite_completed_at',
    'lastProgressReconciliation'
  ],
  timestamp: '2025-04-25T19:07:03.477Z'
}
7:07:03 PM [info] POST /api/tasks/646/update-progress 200 in 102ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
[KYB API Debug] Retrieved responses: { responseCount: 0, fields: [], timestamp: '2025-04-25T19:07:03.514Z' }
[SERVER DEBUG] No savedFormData found in task table
[SERVER DEBUG] No KYB form file ID found in task metadata
[KYB API Debug] Task is submitted, enforcing 100% progress (original was 100%)
[KYB API Debug] Retrieved task data: {
  id: 646,
  responseCount: 0,
  progress: 100,
  status: 'submitted',
  formDataKeys: []
}
===============================================
[SERVER DEBUG] PREPARING GET RESPONSE at 2025-04-25T19:07:03.514Z
[SERVER DEBUG] Task ID: 646, Found 0 fields in database
===============================================
[SERVER DEBUG] Checking field corporateRegistration in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field goodStanding in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field regulatoryActions in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field investigationsIncidents in retrieved data: NOT PRESENT
[SERVER DEBUG] No fields with value "asdf" found in GET response data
[SERVER DEBUG] Sending GET response with 0 fields, status: submitted, progress: 100%
===============================================
7:07:03 PM [info] GET /api/kyb/progress/646 200 in 148ms :: {"formData":{},"progress":100,"status":"submitted"}
New WebSocket client connected
[KYB API Debug] Loading progress for task: 646
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[KYB API Debug] Retrieved task: {
  taskId: 646,
  status: 'submitted',
  progress: 100,
  metadata: [
    'locked',
    'company_id',
    'created_at',
    'created_via',
    'status_flow',
    'company_name',
    'last_updated',
    'created_by_id',
    'progressHistory',
    'prerequisite_for',
    'prerequisite_task_id',
    'prerequisite_completed',
    'prerequisite_task_type',
    'prerequisite_completed_at',
    'lastProgressReconciliation'
  ],
  timestamp: '2025-04-25T19:07:03.778Z'
}
[KYB API Debug] Retrieved responses: { responseCount: 0, fields: [], timestamp: '2025-04-25T19:07:03.816Z' }
[SERVER DEBUG] No savedFormData found in task table
[SERVER DEBUG] No KYB form file ID found in task metadata
[KYB API Debug] Task is submitted, enforcing 100% progress (original was 100%)
[KYB API Debug] Retrieved task data: {
  id: 646,
  responseCount: 0,
  progress: 100,
  status: 'submitted',
  formDataKeys: []
}
===============================================
[SERVER DEBUG] PREPARING GET RESPONSE at 2025-04-25T19:07:03.817Z
[SERVER DEBUG] Task ID: 646, Found 0 fields in database
===============================================
[SERVER DEBUG] Checking field corporateRegistration in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field goodStanding in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field regulatoryActions in retrieved data: NOT PRESENT
[SERVER DEBUG] Checking field investigationsIncidents in retrieved data: NOT PRESENT
[SERVER DEBUG] No fields with value "asdf" found in GET response data
[SERVER DEBUG] Sending GET response with 0 fields, status: submitted, progress: 100%
===============================================
7:07:03 PM [info] GET /api/kyb/progress/646 304 in 154ms :: {"formData":{},"progress":100,"status":"submitted"}
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:07:04.059Z' }
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:07:04.136Z'
}
7:07:04 PM [info] POST /api/tasks/646/update-progress 200 in 114ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
7:07:12 PM [info] GET /api/companies/current 304 in 42ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
7:07:22 PM [info] GET /api/companies/current 304 in 36ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[WebSocket] Received ping
7:07:33 PM [info] GET /api/companies/current 304 in 34ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[Current Company] Fetching company for user: { userId: 286, companyId: 244 }
[Current Company] Found company: {
  id: 244,
  name: 'DevTest33',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
7:07:43 PM [info] GET /api/companies/current 304 in 73ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
7:07:53 PM [info] GET /api/companies/current 304 in 38ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[WebSocket] Received ping
7:08:03 PM [info] GET /api/companies/current 304 in 35ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
7:08:13 PM [info] GET /api/companies/current 304 in 41ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
7:08:24 PM [info] GET /api/companies/current 304 in 34ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[WebSocket] Received ping
7:08:34 PM [info] GET /api/companies/current 304 in 44ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[Current Company] Fetching company for user: { userId: 286, companyId: 244 }
[Current Company] Found company: {
  id: 244,
  name: 'DevTest33',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
7:08:44 PM [info] GET /api/companies/current 304 in 70ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[Current Company] Using cached company data: 244
7:08:54 PM [info] GET /api/companies/current 304 in 43ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[WebSocket] Received ping
[WebSocket] Received ping
7:09:05 PM [info] GET /api/companies/current 304 in 34ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[2025-04-25T19:09:13.884Z] [INFO] [KY3PDemoAutofill] Demo auto-fill requested for KY3P task {"taskId":646,"userId":286}
[2025-04-25T19:09:14.023Z] [INFO] [KY3PDemoAutofill] Found 120 KY3P fields with demo values for task 646
[2025-04-25T19:09:14.066Z] [INFO] [KY3PDemoAutofill] Cleared existing responses for task 646
Suppressing further connection logs. Pool size: 3
[2025-04-25T19:09:15.476Z] [INFO] [KY3PDemoAutofill] Successfully inserted 120 KY3P responses for task 646
[2025-04-25T19:09:15.512Z] [INFO] [KY3PDemoAutofill] Updated task progress after demo auto-fill {"taskId":646,"progress":100,"status":"submitted"}
[WebSocket] Broadcast "task_updated" sent to 3 clients {
  type: 'task_updated',
  dataKeys: [ 'id', 'taskId', 'status', 'progress', 'source', 'timestamp' ],
  timestamp: '2025-04-25T19:09:15.512Z',
  clientCount: 3
}
7:09:15 PM [info] GET /api/companies/current 304 in 36ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
7:09:15 PM [info] POST /api/ky3p/demo-autofill/646 200 in 1665ms :: {"success":true,"message":"KY3P form auto-filled with demo data","responsesIn...
[Tasks Routes] Fetching task by ID (special .json endpoint): {
  taskId: 646,
  userCompanyId: 244,
  timestamp: '2025-04-25T19:09:15.669Z'
}
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:09:15.701Z' }
[Tasks Routes] Task found by ID (special .json endpoint): {
  taskId: 646,
  title: '2. S&P KY3P Security Assessment: DevTest33',
  type: 'ky3p',
  formDataFields: 0,
  timestamp: '2025-04-25T19:09:15.704Z'
}
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Tasks Routes] Updating task progress: { taskId: 646, timestamp: '2025-04-25T19:09:15.734Z' }
7:09:15 PM [info] GET /api/tasks.json/646 200 in 71ms :: {"id":646,"title":"2. S&P KY3P Security Assessment: DevTest33","description":...
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:09:15.763Z'
}
[Task Reconciliation] Skipping task in terminal/submitted state: {
  taskId: 646,
  status: 'submitted',
  hasSubmissionDate: false,
  submissionDate: undefined,
  terminalState: true
}
[Tasks Routes] Task progress reconciled: {
  taskId: 646,
  progress: 100,
  status: 'submitted',
  timestamp: '2025-04-25T19:09:15.795Z'
}
7:09:15 PM [info] POST /api/tasks/646/update-progress 200 in 105ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
7:09:15 PM [info] POST /api/tasks/646/update-progress 200 in 92ms :: {"success":true,"progress":100,"status":"submitted","taskId":646}
7:09:25 PM [info] GET /api/companies/current 304 in 36ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[WebSocket] Received ping
7:09:35 PM [info] GET /api/companies/current 304 in 30ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...
[Current Company] Fetching company for user: { userId: 286, companyId: 244 }
[Current Company] Found company: {
  id: 244,
  name: 'DevTest33',
  onboardingCompleted: false,
  riskScore: null,
  chosenScore: null,
  isDemo: true
}
7:09:46 PM [info] GET /api/companies/current 304 in 60ms :: {"id":244,"name":"DevTest33","category":"FinTech","is_demo":true,"revenue_tie...