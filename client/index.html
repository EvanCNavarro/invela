<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invela</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Fix for Vite WebSocket connection issues in Replit environment -->
    <script>
      // This script runs before Vite initializes to patch WebSocket
      (function() {
        // Capture the original WebSocket constructor
        const OriginalWebSocket = window.WebSocket;
        
        // Set up some variables to manage connection attempts
        let fixApplied = false;
        let connectionAttempts = 0;
        const maxRetries = 5;
        let suppressLogging = false;
        
        // Override the WebSocket constructor to handle the 'undefined' port issue
        window.WebSocket = function(url, protocols) {
          // Only fix URLs for Vite HMR (hot module replacement)
          if (url && typeof url === 'string' && 
              (url.includes('localhost:undefined') || url.endsWith(':undefined/')) && 
              url.includes('vite')) {
                
            // Track connection attempts for Vite
            if (url.includes('vite')) {
              connectionAttempts++;
              
              // After several attempts, start suppressing logging
              if (connectionAttempts > maxRetries && !suppressLogging) {
                console.log(`[WebSocket] Suppressing further connection logs after ${maxRetries} attempts`);
                suppressLogging = true;
              }
            }
            
            // Replace the invalid URL with one that will work in the Replit environment
            const fixedUrl = url.replace(/localhost:undefined/, 'localhost:5000');
            
            // Only log if we're not suppressing
            if (!suppressLogging) {
              console.log(`[WebSocket Fix] Fixed Vite WebSocket URL: ${url} â†’ ${fixedUrl}`);
            }
            
            try {
              return new OriginalWebSocket(fixedUrl, protocols);
            } catch (err) {
              if (!suppressLogging) {
                console.warn(`[WebSocket] Failed to connect to ${fixedUrl}:`, err);
              }
              // Return a proxy object to prevent further errors
              return createDummyWebSocket();
            }
          }
          
          // For all other WebSocket connections, use the original behavior
          return new OriginalWebSocket(url, protocols);
        };
        
        // Create a dummy WebSocket object that doesn't do anything
        function createDummyWebSocket() {
          const dummy = {
            addEventListener: function() {},
            removeEventListener: function() {},
            send: function() {},
            close: function() {},
            readyState: 3, // CLOSED
            CONNECTING: 0,
            OPEN: 1,
            CLOSING: 2,
            CLOSED: 3
          };
          
          // Add event handlers
          ['open', 'message', 'close', 'error'].forEach(event => {
            dummy['on' + event] = null;
          });
          
          return dummy;
        }
        
        // Copy over static properties
        Object.keys(OriginalWebSocket).forEach(key => {
          window.WebSocket[key] = OriginalWebSocket[key];
        });
        
        // Copy prototype (carefully)
        try {
          window.WebSocket.prototype = OriginalWebSocket.prototype;
          window.WebSocket.prototype.constructor = window.WebSocket;
        } catch (e) {
          console.warn('[WebSocket] Error setting up WebSocket prototype:', e);
        }
        
        if (!fixApplied) {
          console.log('[WebSocket Fix] Installed Vite WebSocket port fix');
          fixApplied = true;
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>