> rest-express@1.0.0 dev
> tsx server/index.ts

[EmailService] Initializing email service
[EmailService] Email service initialized successfully
[Auth] Setting up authentication...
[Auth] Authentication setup completed
[Routes] Routes setup completed
[WebSocket] Server initialized on path: /ws
Re-optimizing dependencies because lockfile has changed
12:27:39 PM [express] Server running on port 5000
New WebSocket client connected
[Auth] Unauthenticated user session
WebSocket client disconnected with code 1001 and reason: 
[2025-02-21T12:28:30.721Z] New client connected to the pool
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[2025-02-21T12:28:31.181Z] New client connected to the pool
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[2025-02-21T12:28:31.802Z] New client connected to the pool
[2025-02-21T12:28:31.803Z] New client connected to the pool
[2025-02-21T12:28:31.809Z] New client connected to the pool
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Returning user session data
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
New WebSocket client connected
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 113, company_id: 87, email: 'e.vancnavarro@gmail.com' }
[Current Company] Fetching company for user: { userId: 113, companyId: 87 }
[Tasks] KYB tasks found: {
  count: 1,
  tasks: [
    {
      id: 128,
      company_id: 87,
      task_scope: 'company',
      task_type: 'company_kyb',
      assigned_to: null,
      status: 'pending'
    }
  ]
}
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 113',
    condition2: 'tasks.created_by = 113',
    condition3: "tasks.company_id = 87 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('e.vancnavarro@gmail.com')"
  }
}
[Current Company] Found company: { id: 87, name: 'Moneyhub', onboardingCompleted: false }
[Tasks] Tasks found: {
  count: 2,
  tasks: [
    {
      id: 128,
      title: 'Company KYB: Moneyhub',
      assigned_to: null,
      company_id: 87,
      task_scope: 'company',
      task_type: 'company_kyb',
      status: 'pending'
    },
    {
      id: 129,
      title: 'New User Invitation: e.vancnavarro@gmail.com',
      assigned_to: 113,
      company_id: 87,
      task_scope: 'user',
      task_type: 'user_onboarding',
      status: 'completed'
    }
  ]
}
12:28:38 PM [info] GET /api/companies/current 304 in 77ms :: {"id":87,"name":"Moneyhub","description":null,"category":"FinTech","logo_id":...
12:28:38 PM [info] GET /api/tasks 304 in 103ms :: [{"id":128,"title":"Company KYB: Moneyhub","description":"Complete KYB verifi...
[Auth] Deserializing user: 113
[Tasks] ====== Starting task fetch =====
[Tasks] User details: { id: 113, company_id: 87, email: 'e.vancnavarro@gmail.com' }
[Tasks] KYB tasks found: {
  count: 1,
  tasks: [
    {
      id: 128,
      company_id: 87,
      task_scope: 'company',
      task_type: 'company_kyb',
      assigned_to: null,
      status: 'pending'
    }
  ]
}
[Tasks] Query conditions: {
  conditions: {
    condition1: 'tasks.assigned_to = 113',
    condition2: 'tasks.created_by = 113',
    condition3: "tasks.company_id = 87 AND tasks.assigned_to IS NULL AND tasks.task_scope = 'company'",
    condition4: "tasks.task_type = 'user_onboarding' AND LOWER(tasks.user_email) = LOWER('e.vancnavarro@gmail.com')"
  }
}
[Tasks] Tasks found: {
  count: 2,
  tasks: [
    {
      id: 128,
      title: 'Company KYB: Moneyhub',
      assigned_to: null,
      company_id: 87,
      task_scope: 'company',
      task_type: 'company_kyb',
      status: 'pending'
    },
    {
      id: 129,
      title: 'New User Invitation: e.vancnavarro@gmail.com',
      assigned_to: 113,
      company_id: 87,
      task_scope: 'user',
      task_type: 'user_onboarding',
      status: 'completed'
    }
  ]
}
12:28:38 PM [info] GET /api/tasks 304 in 92ms :: [{"id":128,"title":"Company KYB: Moneyhub","description":"Complete KYB verifi...
New WebSocket client connected
WebSocket client disconnected with code 1005 and reason: 
[Auth] Deserializing user: 113
[KYB API] Searching for company: moneyhub
[KYB API] Found task: {
  id: 128,
  title: 'Company KYB: Moneyhub',
  description: 'Complete KYB verification for Moneyhub',
  task_type: 'company_kyb',
  task_scope: 'company',
  status: 'pending',
  priority: 'high',
  progress: 0,
  assigned_to: null,
  created_by: 8,
  company_id: 87,
  user_email: null,
  due_date: 2025-03-06T11:58:19.322Z,
  completion_date: null,
  files_requested: [],
  files_uploaded: [],
  metadata: {
    company: { id: 87, name: 'Moneyhub', description: null },
    companyId: 87,
    createdVia: 'fintech_invite',
    statusFlow: [ 'pending' ],
    companyName: 'Moneyhub'
  },
  created_at: 2025-02-20T11:58:19.262Z,
  updated_at: 2025-02-20T11:58:19.262Z
}
12:28:39 PM [info] GET /api/tasks/kyb/moneyhub 304 in 63ms :: {"id":128,"title":"Company KYB: Moneyhub","description":"Complete KYB verific...
[Auth] Deserializing user: 113
[Company Search] Starting search for: moneyhub
[Company Search] Error: TypeError: db.sql is not a function
    at <anonymous> (/home/runner/workspace/server/routes/company-search.ts:50:17)
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at next (/home/runner/workspace/node_modules/express/lib/router/route.js:149:13)
    at Route.dispatch (/home/runner/workspace/node_modules/express/lib/router/route.js:119:3)
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at /home/runner/workspace/node_modules/express/lib/router/index.js:284:15
    at Function.process_params (/home/runner/workspace/node_modules/express/lib/router/index.js:346:12)
    at next (/home/runner/workspace/node_modules/express/lib/router/index.js:280:10)
    at Function.handle (/home/runner/workspace/node_modules/express/lib/router/index.js:175:3)
    at router (/home/runner/workspace/node_modules/express/lib/router/index.js:47:12)
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at trim_prefix (/home/runner/workspace/node_modules/express/lib/router/index.js:328:13)
    at /home/runner/workspace/node_modules/express/lib/router/index.js:286:9
    at Function.process_params (/home/runner/workspace/node_modules/express/lib/router/index.js:346:12)
    at next (/home/runner/workspace/node_modules/express/lib/router/index.js:280:10)
    at <anonymous> (/home/runner/workspace/server/index.ts:80:3)
    at Layer.handle [as handle_request] (/home/runner/workspace/node_modules/express/lib/router/layer.js:95:5)
    at trim_prefix (/home/runner/workspace/node_modules/express/lib/router/index.js:328:13)
    at /home/runner/workspace/node_modules/express/lib/router/index.js:286:9
    at Function.process_params (/home/runner/workspace/node_modules/express/lib/router/index.js:346:12)
    at next (/home/runner/workspace/node_modules/express/lib/router/index.js:280:10)
    at strategy.pass (/home/runner/workspace/node_modules/passport/lib/middleware/authenticate.js:355:9)
    at /home/runner/workspace/node_modules/passport/lib/strategies/session.js:120:12
    at pass (/home/runner/workspace/node_modules/passport/lib/authenticator.js:352:31)
    at deserialized (/home/runner/workspace/node_modules/passport/lib/authenticator.js:364:7)
    at <anonymous> (/home/runner/workspace/server/auth.ts:179:7)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
New WebSocket client connected
12:28:40 PM [error] POST /api/company-search 500 in 37ms :: {"success":false,"error":"Failed to search company information","details":"db...
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client
[WebSocket] Received pong from client

12:32:00 PM [vite] hmr update /src/components/playground/OnboardingKYBFormPlayground.tsx, /src/index.css?v=h08g_tSOKC4UKjRtmpZjo
[2025-02-21T12:32:00.820Z] New client connected to the pool
[2025-02-21T12:32:00.829Z] New client connected to the pool
WebSocket client disconnected with code 1001 and reason: 
WebSocket client disconnected with code 1001 and reason: 
[Auth] Deserializing user: 113
[Auth] Deserializing user: 113
Received SIGTERM. Closing pool...
Database pool closed successfully
